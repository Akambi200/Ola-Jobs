<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ola Job's ‚Äî Plateforme</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;color:#333
    }
    .header{
      background:rgba(255,255,255,.95);backdrop-filter:blur(10px);
      box-shadow:0 4px 20px rgba(0,0,0,.1);position:sticky;top:0;z-index:1000
    }
    .nav-container{
      max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem
    }
    .logo{display:flex;align-items:center;gap:.5rem;font-size:1.5rem;font-weight:700;color:#667eea}
    .logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:1.2rem}
    .nav-menu{display:flex;list-style:none;gap:1rem;flex-wrap:wrap}
    .nav-item{cursor:pointer;padding:.5rem 1rem;border-radius:25px;transition:.25s;font-weight:500;border:2px solid transparent}
    .nav-item:hover{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;transform:translateY(-2px)}
    .nav-item.locked{border-color:#e5e7eb;color:#9ca3af;cursor:not-allowed}
    main{max-width:1200px;margin:2rem auto;padding:0 2rem}
    .section{display:none;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:20px;padding:2rem;box-shadow:0 8px 32px rgba(0,0,0,.1);animation:fadeIn .5s ease}
    .section.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    h1,h2{margin-bottom:1rem;color:#333;text-align:center}
    h1{font-size:2.2rem;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    form{max-width:650px;margin:0 auto;display:flex;flex-direction:column;gap:.85rem}
    label{font-size:.95rem;font-weight:600}
    input,select,textarea,button{
      padding:.9rem;border:2px solid #e1e5e9;border-radius:12px;font-size:1rem;transition:.2s;background:#fff
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    textarea{resize:vertical;min-height:120px}
    button{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;cursor:pointer;font-weight:700}
    button:hover{transform:translateY(-1px);box-shadow:0 8px 25px rgba(102,126,234,.25)}
    button:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .muted{color:#64748b;font-size:.9rem}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:.85rem}
    .success-msg{color:#22c55e;text-align:center;font-weight:700;padding:.8rem;background:rgba(34,197,94,.1);border-radius:8px;margin-top:.5rem}
    .error-msg{color:#ef4444;text-align:center;font-weight:600;padding:.8rem;background:rgba(239,68,68,.08);border-radius:8px;margin-top:.5rem}
    .hidden{display:none}
    .service-item{background:rgba(255,255,255,.88);border-radius:12px;padding:1rem;margin-bottom:1rem;border-left:4px solid #667eea;transition:.2s}
    .service-item:hover{transform:translateX(3px);box-shadow:0 4px 20px rgba(0,0,0,.08)}
    .service-title{font-weight:800;color:#667eea;margin-bottom:.3rem}
    .service-meta{display:flex;justify-content:space-between;gap:1rem;margin-top:.5rem;font-size:.92rem;color:#666;flex-wrap:wrap}
    .badge{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:700;font-size:.8rem}
    .budget{font-weight:800;color:#22c55e}
    .user-status{position:fixed;top:100px;right:2rem;background:rgba(255,255,255,.95);padding:1rem;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.1);backdrop-filter:blur(10px)}
    .salons{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem}
    .salon{background:#fff;border:2px solid #e5e7eb;border-radius:12px;padding:1rem;cursor:pointer;transition:.2s}
    .salon:hover{border-color:#667eea;transform:translateY(-2px)}
    .thread{margin-top:1rem;border-top:2px solid #e5e7eb;padding-top:1rem}
    .msg{padding:.7rem;border:1px solid #e5e7eb;border-radius:10px;margin:.5rem 0;background:#fafafa}
    .msg.own-message{background:#eef2ff;border-color:#667eea}
    .msg small{color:#6b7280}
    .pill{display:inline-flex;align-items:center;gap:.4rem;border:1px solid #e5e7eb;border-radius:999px;padding:.2rem .6rem;font-size:.8rem}
    .password-display-box{
      background:#f8fafc;
      border:2px dashed #667eea;
      border-radius:8px;
      padding:1rem;
      margin:.5rem 0;
      text-align:center;
    }
    .password-text{
      font-size:1.3rem;
      font-weight:700;
      color:#667eea;
      letter-spacing:2px;
      font-family:monospace;
    }
    .chat-container{
      max-height:500px;
      overflow-y:auto;
      background:#f9fafb;
      border-radius:8px;
      padding:1rem;
      margin-bottom:1rem;
    }
    .back-btn{
      background:#6b7280;
      padding:.5rem 1rem;
      font-size:.9rem;
      margin-bottom:1rem;
      display:inline-block;
    }
    @media(max-width:768px){
      .nav-menu{gap:.5rem}
      .nav-container{flex-direction:column;gap:.6rem}
      .row{grid-template-columns:1fr}
      .user-status{position:static;margin:1rem 0}
    }
  </style>
</head>
<body>
<header class="header">
  <div class="nav-container">
    <div class="logo">
      <div class="logo-icon">O</div><span>Ola Job's</span>
    </div>
    <nav>
      <ul class="nav-menu">
        <li class="nav-item" onclick="showSection('home')">Plateforme</li>
        <li class="nav-item" onclick="showSection('register')">Cr√©er un compte</li>
        <li class="nav-item" onclick="showSection('login')">Connexion</li>
        <li id="nav-create" class="nav-item locked" onclick="guardedNav('create')">Cr√©er une offre</li>
        <li id="nav-list" class="nav-item locked" onclick="guardedNav('list')">Liste des Services</li>
        <li id="nav-community" class="nav-item locked" onclick="guardedNav('community')">Communaut√©</li>
      </ul>
    </nav>
  </div>
</header>

<div id="user-status" class="user-status hidden">
  <div id="user-welcome"></div>
</div>

<main>
  <!-- Accueil -->
  <section id="home" class="section active" aria-labelledby="home-title">
    <h1 id="home-title">Bienvenue sur Ola Job's</h1>
    <p class="muted" style="text-align:center;max-width:800px;margin:.5rem auto 0">
      √âchange de services locaux, comp√©tences et entraide communautaire au B√©nin.
    </p>
    <div style="text-align:center;margin-top:1.2rem">
      <button onclick="showSection('register')" style="margin-right:.5rem">Commencer maintenant</button>
      <button onclick="guardedNav('list')" style="background:transparent;color:#667eea;border:2px solid #667eea">
        Voir les services
      </button>
    </div>
  </section>

  <!-- Inscription -->
  <section id="register" class="section" aria-labelledby="register-title">
    <h2 id="register-title">Cr√©er un compte</h2>
    <form id="register-form">
      <label for="reg-username">Nom d'utilisateur</label>
      <input id="reg-username" required/>

      <label for="reg-email">Email</label>
      <input id="reg-email" type="email" required/>

      <label for="reg-password">Mot de passe</label>
      <input id="reg-password" type="password" minlength="4" required/>

      <label for="reg-city">Ville</label>
      <input id="reg-city" required/>

      <button type="submit">S'inscrire</button>
      <p id="register-success" class="success-msg hidden">Inscription r√©ussie ! Vous pouvez vous connecter.</p>
    </form>
  </section>

  <!-- Connexion -->
  <section id="login" class="section" aria-labelledby="login-title">
    <h2 id="login-title">Connexion</h2>
    <form id="login-form">
      <label for="login-user">Nom d'utilisateur ou Email</label>
      <input id="login-user" required/>

      <label for="login-pass">Mot de passe</label>
      <input id="login-pass" type="password" required/>

      <button type="submit">Se connecter</button>
      
      <p style="text-align:center;margin-top:.8rem">
        <a href="#" onclick="showSection('forgot-password'); return false;" style="color:#667eea;text-decoration:underline;font-size:.9rem">
          Mot de passe oubli√© ?
        </a>
      </p>
      
      <p id="login-success" class="success-msg hidden">Connexion r√©ussie ! Bienvenue.</p>
      <p id="login-error" class="error-msg hidden">Identifiants incorrects.</p>
    </form>
  </section>

  <!-- Mot de passe oubli√© -->
  <section id="forgot-password" class="section" aria-labelledby="forgot-title">
    <h2 id="forgot-title">R√©initialiser le mot de passe</h2>
    
    <p class="muted" style="text-align:center;max-width:500px;margin:0 auto 1.5rem">
      Entrez votre nom d'utilisateur ou email. Nous afficherons vos informations si le compte existe.
    </p>
    
    <form id="forgot-form">
      <label for="forgot-identifier">Nom d'utilisateur ou Email</label>
      <input id="forgot-identifier" required placeholder="Votre username ou email"/>

      <button type="submit">R√©cup√©rer mes informations</button>
      
      <div id="forgot-result" class="hidden"></div>
      
      <p style="text-align:center;margin-top:1rem">
        <a href="#" onclick="showSection('login'); return false;" style="color:#667eea;text-decoration:underline;font-size:.9rem">
          ‚Üê Retour √† la connexion
        </a>
      </p>
    </form>
  </section>

  <!-- Cr√©er une OFFRE -->
  <section id="create" class="section" aria-labelledby="create-title">
    <h2 id="create-title">Cr√©er une offre de service</h2>
    <form id="service-form">
      <div class="pill" aria-label="Type d'annonce"><span>üíº</span><strong>Offre de service</strong></div>

      <label for="title">Titre de l'offre</label>
      <input id="title" placeholder="Ex. R√©paration de climatiseur" required/>

      <label for="description">Description d√©taill√©e</label>
      <textarea id="description" placeholder="D√©crivez pr√©cis√©ment la prestation..." required></textarea>

      <div class="row">
        <div>
          <label for="category">Cat√©gorie</label>
          <select id="category" required onchange="toggleOtherCategory()">
            <option value="">Choisir...</option>
            <option value="menage">M√©nage</option>
            <option value="jardinage">Jardinage</option>
            <option value="bricolage">Bricolage</option>
            <option value="informatique">Informatique</option>
            <option value="cours">Cours particuliers</option>
            <option value="transport">Transport</option>
            <option value="cuisine">Cuisine</option>
            <option value="autre">Autre (pr√©ciser)</option>
          </select>
        </div>
        <div id="other-cat-wrap" class="hidden">
          <label for="other-category">Pr√©ciser la cat√©gorie</label>
          <input id="other-category" placeholder="Ex. Couture, Coiffure, etc."/>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="location">Lieu (quartier, ville)</label>
          <input id="location" placeholder="Ex. Cotonou, Akpakpa" required/>
        </div>
        <div>
          <label for="phone">T√©l√©phone</label>
          <input id="phone" inputmode="tel" pattern="[0-9+\s]{6,}" placeholder="+229 01 90 00 00 00" required/>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="date">Date d'ex√©cution</label>
          <input id="date" type="date" required/>
        </div>
        <div>
          <label for="time">Heure d'ex√©cution</label>
          <input id="time" type="time" required/>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="budget-select">Budget (FCFA)</label>
          <select id="budget-select" required onchange="toggleCustomBudget()">
            <option value="">Choisir un tarif...</option>
            <option value="1000">1 000</option>
            <option value="2000">2 000</option>
            <option value="3000">3 000</option>
            <option value="5000">5 000</option>
            <option value="10000">10 000</option>
            <option value="15000">15 000</option>
            <option value="20000">20 000</option>
            <option value="custom">Autre montant‚Ä¶</option>
          </select>
        </div>
        <div id="custom-budget-wrap" class="hidden">
          <label for="budget">Autre montant (‚â• 1 000)</label>
          <input id="budget" type="number" min="1000" step="500" placeholder="Ex. 25 000"/>
        </div>
      </div>

      <button type="submit">Publier l'offre</button>
      <p id="service-success" class="success-msg hidden">Offre publi√©e avec succ√®s !</p>
    </form>
  </section>

  <!-- Liste des services -->
  <section id="list" class="section" aria-labelledby="list-title">
    <h2 id="list-title">Services publi√©s</h2>
    
    <div style="background:#eff6ff;border:1px solid #3b82f6;border-radius:8px;padding:.8rem;margin-bottom:1rem;font-size:.9rem">
      ‚ÑπÔ∏è <strong>Pour votre s√©curit√© :</strong> Les num√©ros sont masqu√©s. Utilisez le bouton "Contacter" pour joindre le prestataire via WhatsApp.
    </div>
    
    <div style="text-align:center;margin-bottom:1rem">
      <select id="filter-category" onchange="displayServices()">
        <option value="">Toutes les cat√©gories</option>
        <option value="menage">M√©nage</option>
        <option value="jardinage">Jardinage</option>
        <option value="bricolage">Bricolage</option>
        <option value="informatique">Informatique</option>
        <option value="cours">Cours particuliers</option>
        <option value="transport">Transport</option>
        <option value="cuisine">Cuisine</option>
        <option value="autre">Autre</option>
      </select>
    </div>
    <div id="services-list"></div>
    <p id="no-services" class="muted" style="text-align:center"></p>
  </section>

  <!-- Communaut√© -->
  <section id="community" class="section" aria-labelledby="community-title">
    <h2 id="community-title">Communaut√© d'√©change</h2>
    <p class="muted" style="text-align:center;margin-bottom:1rem">
      Choisis un salon et commence la discussion avec les autres membres.
    </p>

    <div class="salons" id="salon-grid"></div>

    <div id="salon-panel" class="hidden">
      <button class="back-btn" onclick="closeSalon()">‚Üê Retour aux salons</button>
      <div class="thread">
        <h3 id="salon-title" style="text-align:left;margin-bottom:.5rem"></h3>
        <div class="chat-container" id="messages"></div>
        <form id="msg-form" style="margin-top:.8rem">
          <label for="msg-input">Votre message</label>
          <textarea id="msg-input" required placeholder="√âcris ton message‚Ä¶" rows="3"></textarea>
          <button type="submit" style="margin-top:.5rem">Envoyer</button>
        </form>
      </div>
    </div>
  </section>
</main>

<script>
/** =========================
 *  Configuration Admin
 *  ========================= */
const ADMIN_USERNAME = 'Allah'; // Nom d'utilisateur admin
const INTERMEDIARY_PHONE = '+229 01 47 73 68 67'; // Num√©ro interm√©diaire

/** =========================
 *  Donn√©es & persistance
 *  ========================= */
let currentUser = null;
let users = [];
let services = [];
let messages = {}; // { salonKey: [{author, text, ts}] }

const SALONS = [
  { key:'entrepreneuriat', name:'Entrepreneuriat' },
  { key:'education', name:'√âducation sexuelle & formation' },
  { key:'agro', name:'Agro-industrie' },
  { key:'sante', name:'Sant√© & Bien-√™tre (√âchanges Sportifs)' },
  { key:'numerique', name:'Num√©rique & Technologie' },
  { key:'environnement', name:'Environnement' },
  { key:'commerce', name:'Commerce & E‚Äëcommerce' },
  { key:'culture', name:'Culture' },
];

function loadState(){
  users = JSON.parse(localStorage.getItem('ola_users')||'[]');
  services = JSON.parse(localStorage.getItem('ola_services')||'[]');
  messages = JSON.parse(localStorage.getItem('ola_messages')||'{}');
  const savedUser = JSON.parse(localStorage.getItem('ola_current_user')||'null');
  if(savedUser){ currentUser = savedUser; updateUserStatus(); setProtectedNav(true);}
}
function saveUsers(){ localStorage.setItem('ola_users', JSON.stringify(users)); }
function saveServices(){ localStorage.setItem('ola_services', JSON.stringify(services)); }
function saveMessages(){ localStorage.setItem('ola_messages', JSON.stringify(messages)); }
function saveCurrentUser(){ 
  if(currentUser) localStorage.setItem('ola_current_user', JSON.stringify(currentUser));
  else localStorage.removeItem('ola_current_user');
}

/** =========================
 *  Navigation & garde
 *  ========================= */
function showSection(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({top:0, behavior:'smooth'});
}
function setProtectedNav(connected){
  ['nav-create','nav-list','nav-community'].forEach(id=>{
    const el = document.getElementById(id);
    if(connected){ el.classList.remove('locked'); }
    else{ el.classList.add('locked'); }
  });
}
function guardedNav(sectionId){
  if(!currentUser){
    alert('Veuillez vous connecter pour acc√©der √† cette section.');
    showSection('login');
    return;
  }
  showSection(sectionId);
}

/** =========================
 *  Inscription / connexion
 *  ========================= */
document.getElementById('register-form').addEventListener('submit', (e)=>{
  e.preventDefault();
  const username = document.getElementById('reg-username').value.trim();
  const email = document.getElementById('reg-email').value.trim().toLowerCase();
  const password = document.getElementById('reg-password').value;
  const city = document.getElementById('reg-city').value.trim();

  if(users.some(u=>u.username===username || u.email===email)){
    alert('Un compte existe d√©j√† avec ce nom d\'utilisateur ou cet email.');
    return;
  }
  const newUser = { id:Date.now(), username, email, password, city };
  users.push(newUser); saveUsers();

  document.getElementById('register-success').classList.remove('hidden');
  e.target.reset();
  setTimeout(()=>showSection('login'), 1500);
});

document.getElementById('login-form').addEventListener('submit', (e)=>{
  e.preventDefault();
  const idf = document.getElementById('login-user').value.trim().toLowerCase();
  const pass = document.getElementById('login-pass').value;
  const user = users.find(u => (u.username.toLowerCase()===idf || u.email===idf) && u.password===pass);
  
  document.getElementById('login-error').classList.add('hidden');
  document.getElementById('login-success').classList.add('hidden');

  if(user){
    currentUser = user; saveCurrentUser();
    document.getElementById('login-success').classList.remove('hidden');
    updateUserStatus(); setProtectedNav(true); e.target.reset();
    setTimeout(()=>showSection('home'), 1200);
  } else {
    document.getElementById('login-error').classList.remove('hidden');
  }
});

function updateUserStatus(){
  const statusDiv = document.getElementById('user-status');
  const welcomeDiv = document.getElementById('user-welcome');

  if(currentUser){
    const adminBadge = currentUser.username === ADMIN_USERNAME ? '<span class="badge" style="background:#ef4444;color:#fff;margin-left:.5rem">üëë ADMIN</span>' : '';
    welcomeDiv.innerHTML = `
      <strong>Bonjour ${escapeHtml(currentUser.username)} !</strong>${adminBadge}<br>
      <small>${escapeHtml(currentUser.city)}</small><br>
      <button onclick="logout()" style="margin-top:.5rem;padding:.5rem;font-size:.85rem">D√©connexion</button>
    `;
    statusDiv.classList.remove('hidden');
  } else {
    statusDiv.classList.add('hidden');
  }
}
function logout(){
  currentUser = null; saveCurrentUser(); setProtectedNav(false);
  updateUserStatus(); showSection('home');
}

/** =========================
 *  Mot de passe oubli√© - VERSION CORRIG√âE
 *  ========================= */
document.getElementById('forgot-form').addEventListener('submit', (e)=>{
  e.preventDefault();
  
  const identifier = document.getElementById('forgot-identifier').value.trim().toLowerCase();
  const resultDiv = document.getElementById('forgot-result');
  
  // Chercher l'utilisateur
  const user = users.find(u => 
    u.username.toLowerCase() === identifier || 
    u.email.toLowerCase() === identifier
  );
  
  if(user) {
    // Afficher les informations dans une div d√©di√©e
    resultDiv.innerHTML = `
      <div class="success-msg" style="text-align:left">
        <strong style="font-size:1.1rem">‚úÖ Compte trouv√© !</strong><br><br>
        
        <div style="margin:.5rem 0">
          <strong>Nom d'utilisateur :</strong> ${escapeHtml(user.username)}
        </div>
        
        <div style="margin:.5rem 0">
          <strong>Email :</strong> ${escapeHtml(user.email)}
        </div>
        
        <div style="margin:.5rem 0">
          <strong>Ville :</strong> ${escapeHtml(user.city)}
        </div>
        
        <div class="password-display-box">
          <div style="margin-bottom:.5rem"><strong>Votre mot de passe :</strong></div>
          <div class="password-text" id="password-display">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
          <button type="button" onclick="togglePasswordVisibility('${escapeHtml(user.password)}')" 
                  style="margin-top:.8rem;padding:.5rem 1rem;font-size:.9rem;background:#667eea">
            üëÅÔ∏è Afficher le mot de passe
          </button>
        </div>
        
        <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid #22c55e">
          <small style="color:#059669">üí° Notez bien votre mot de passe et connectez-vous.</small>
        </div>
      </div>
    `;
    resultDiv.classList.remove('hidden');
    
    // Pr√©-remplir le formulaire de connexion et rediriger apr√®s 10 secondes
    setTimeout(() => {
      showSection('login');
      document.getElementById('login-user').value = user.username;
    }, 10000);
    
  } else {
    // Compte introuvable
    resultDiv.innerHTML = `
      <div class="error-msg">
        ‚ùå Aucun compte trouv√© avec ces informations.<br>
        <small>V√©rifiez votre saisie ou cr√©ez un nouveau compte.</small>
      </div>
    `;
    resultDiv.classList.remove('hidden');
  }
  
  // Reset le formulaire
  e.target.reset();
});

// Fonction pour afficher/masquer le mot de passe
function togglePasswordVisibility(password) {
  const display = document.getElementById('password-display');
  const btn = event.target;
  
  if(display.textContent === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
    display.textContent = password;
    btn.innerHTML = 'üôà Masquer le mot de passe';
    btn.style.background = '#ef4444';
  } else {
    display.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    btn.innerHTML = 'üëÅÔ∏è Afficher le mot de passe';
    btn.style.background = '#667eea';
  }
}

/** =========================
 *  Cr√©ation d'offre
 *  ========================= */
function toggleOtherCategory(){
  const v = document.getElementById('category').value;
  document.getElementById('other-cat-wrap').classList.toggle('hidden', v!=='autre');
}
function toggleCustomBudget(){
  const v = document.getElementById('budget-select').value;
  document.getElementById('custom-budget-wrap').classList.toggle('hidden', v!=='custom');
}

document.getElementById('service-form').addEventListener('submit', (e)=>{
  e.preventDefault();
  if(!currentUser){ return guardedNav('login'); }

  const title = document.getElementById('title').value.trim();
  const description = document.getElementById('description').value.trim();
  let category = document.getElementById('category').value;
  const other = document.getElementById('other-category').value.trim();
  if(category==='autre'){
    if(!other){ alert('Veuillez pr√©ciser la cat√©gorie.'); return; }
    category = other;
  }

  const location = document.getElementById('location').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const date = document.getElementById('date').value;
  const time = document.getElementById('time').value;
  if(!date || !time){ alert('Veuillez indiquer la date et l\'heure d\'ex√©cution.'); return; }

  const budgetSel = document.getElementById('budget-select').value;
  let budget = 0;
  if(budgetSel==='custom'){
    const v = Number(document.getElementById('budget').value);
    if(!v || v<1000){ alert('Budget minimal 1 000 FCFA.'); return; }
    budget = Math.round(v);
  } else {
    budget = Number(budgetSel||0);
    if(budget<1000){ alert('Budget minimal 1 000 FCFA.'); return; }
  }

  const deadlineISO = new Date(`${date}T${time}:00`).toISOString();

  const newService = {
    id: Date.now(),
    type: 'offre',
    title, description, category, location, phone,
    budget, author: currentUser.username,
    datePublished: new Date().toISOString(),
    deadlineISO
  };

  services.push(newService); saveServices();
  document.getElementById('service-success').classList.remove('hidden');
  e.target.reset();
  document.getElementById('other-cat-wrap').classList.add('hidden');
  document.getElementById('custom-budget-wrap').classList.add('hidden');

  displayServices();
  setTimeout(()=>{
    showSection('list');
    document.getElementById('service-success').classList.add('hidden');
  }, 1500);
});

/** =========================
 *  Liste + expiration auto + Masquage num√©ros CORRIG√â
 *  ========================= */
function isExpired(svc){
  return new Date(svc.deadlineISO).getTime() < Date.now();
}

// Fonction corrig√©e pour l'affichage des num√©ros
function getDisplayPhone(service) {
  // Si pas connect√© ‚Üí num√©ro interm√©diaire
  if (!currentUser) {
    return INTERMEDIARY_PHONE;
  }
  
  // Si c'est l'admin ‚Üí voir TOUS les vrais num√©ros
  if (currentUser.username === ADMIN_USERNAME) {
    return service.phone;
  }
  
  // Si c'est l'auteur de l'offre ‚Üí voir son propre num√©ro
  if (currentUser.username === service.author) {
    return service.phone;
  }
  
  // Tous les autres utilisateurs ‚Üí num√©ro interm√©diaire
  return INTERMEDIARY_PHONE;
}

function contactProvider(phone, serviceTitle, author) {
  const message = encodeURIComponent(`Bonjour ! Je suis int√©ress√©(e) par votre offre "${serviceTitle}" sur Ola Job's. √ätes-vous disponible ?`);
  const whatsappUrl = `https://wa.me/${phone.replace(/[\s-]/g, '')}?text=${message}`;
  window.open(whatsappUrl, '_blank');
}

function displayServices(){
  const servicesList = document.getElementById('services-list');
  const filterCategory = document.getElementById('filter-category').value;
  const valid = services.filter(s => !isExpired(s));
  const filtered = filterCategory ? valid.filter(s => (s.category||'').toLowerCase() === filterCategory.toLowerCase()) : valid;

  // Purge silencieuse des expir√©s
  const keep = services.filter(s => !isExpired(s));
  if(keep.length !== services.length){ services = keep; saveServices(); }

  if(filtered.length===0){
    servicesList.innerHTML = '';
    document.getElementById('no-services').textContent = 'Aucune offre active pour le moment.';
    return;
  }
  document.getElementById('no-services').textContent = '';

  servicesList.innerHTML = filtered.map(service => {
    const when = new Date(service.deadlineISO);
    const dt = when.toLocaleDateString('fr-FR');
    const tm = when.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
    const cat = service.category || 'Non cat√©goris√©';
    const displayPhone = getDisplayPhone(service);
    
    // Badges pour admin et auteur
    const isAdmin = currentUser && currentUser.username === ADMIN_USERNAME;
    const isAuthor = currentUser && currentUser.username === service.author;
    
    let badges = '';
    if (isAdmin && isAuthor) {
      badges = '<span class="badge" style="background:#ef4444;color:#fff;margin-left:.5rem">üëë ADMIN</span><span class="badge" style="background:#22c55e;color:#fff;margin-left:.5rem">‚ú® VOTRE OFFRE</span>';
    } else if (isAdmin) {
      badges = '<span class="badge" style="background:#ef4444;color:#fff;margin-left:.5rem">üëë ADMIN</span>';
    } else if (isAuthor) {
      badges = '<span class="badge" style="background:#22c55e;color:#fff;margin-left:.5rem">‚ú® VOTRE OFFRE</span>';
    }
    
    // Message pour indiquer si le num√©ro est masqu√©
    let phoneInfo = '';
    if (displayPhone === INTERMEDIARY_PHONE) {
      phoneInfo = '<div style="font-size:.85rem;color:#6b7280;margin-top:.3rem">üîí Num√©ro masqu√© - Contactez via l\'interm√©diaire</div>';
    } else {
      phoneInfo = '<div style="font-size:.85rem;color:#22c55e;margin-top:.3rem">‚úÖ Num√©ro r√©el visible</div>';
    }
    
    return `
      <div class="service-item" aria-label="Offre de service">
        <div class="service-title">${escapeHtml(service.title)} ${badges}</div>
        <div class="service-meta">
          <span class="badge">Offre</span>
          <span>${escapeHtml(cat)}</span>
        </div>
        <p style="margin:.6rem 0;">${escapeHtml(service.description)}</p>
        <div class="service-meta">
          <span>üìç ${escapeHtml(service.location)}</span>
          <span class="budget">${(service.budget||0).toLocaleString('fr-FR')} FCFA</span>
        </div>
        <div class="service-meta">
          <span>üìû ${escapeHtml(displayPhone)}</span>
          <span>‚è∞ ${dt} √† ${tm}</span>
        </div>
        ${phoneInfo}
        <div class="service-meta">
          <span>üë§ ${escapeHtml(service.author)}</span>
          <span>üìÖ Publi√© le ${new Date(service.datePublished).toLocaleDateString('fr-FR')}</span>
        </div>
        <div class="service-meta" style="margin-top:.8rem;padding-top:.8rem;border-top:1px solid #e5e7eb">
          <button onclick="contactProvider('${displayPhone}', '${escapeHtml(service.title).replace(/'/g, "\\'")}', '${service.author}')" 
                  style="width:100%;padding:.7rem;background:#22c55e;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700">
            üì± Contacter via WhatsApp
          </button>
        </div>
      </div>
    `;
  }).join('');
}

/** =========================
 *  Communaut√© (salons) - VERSION CORRIG√âE
 *  ========================= */
const salonGrid = document.getElementById('salon-grid');
const salonPanel = document.getElementById('salon-panel');
const salonTitle = document.getElementById('salon-title');
const messagesDiv = document.getElementById('messages');
const msgForm = document.getElementById('msg-form');
let currentSalon = null;
let messageRefreshInterval = null;

function renderSalons(){
  salonGrid.innerHTML = SALONS.map(s=>{
    const msgCount = (messages[s.key] || []).length;
    return `
      <div class="salon" onclick="openSalon('${s.key}')">
        <strong>${s.name}</strong>
        <p class="muted" style="margin-top:.3rem">
          üí¨ ${msgCount} message${msgCount !== 1 ? 's' : ''}<br>
          Rejoins la discussion ‚Üí
        </p>
      </div>
    `;
  }).join('');
}

function openSalon(key){
  if(!currentUser){ return guardedNav('community'); }
  currentSalon = key;
  const meta = SALONS.find(s=>s.key===key);
  salonTitle.textContent = meta ? meta.name : 'Salon';
  salonGrid.classList.add('hidden');
  salonPanel.classList.remove('hidden');
  renderMessages();
  document.getElementById('msg-input').focus();
  
  // Actualiser les messages toutes les 2 secondes
  if(messageRefreshInterval) clearInterval(messageRefreshInterval);
  messageRefreshInterval = setInterval(()=>{
    if(currentSalon) renderMessages();
  }, 2000);
}

function closeSalon(){
  currentSalon = null;
  salonPanel.classList.add('hidden');
  salonGrid.classList.remove('hidden');
  if(messageRefreshInterval){
    clearInterval(messageRefreshInterval);
    messageRefreshInterval = null;
  }
  renderSalons(); // Actualiser le compteur de messages
}

function renderMessages(){
  // Recharger les messages depuis localStorage pour voir ceux des autres
  messages = JSON.parse(localStorage.getItem('ola_messages')||'{}');
  
  const list = messages[currentSalon] || [];
  if(list.length===0){
    messagesDiv.innerHTML = `<p class="muted" style="text-align:center;padding:2rem">Aucun message pour l'instant. Soyez le premier √† √©crire ! üí¨</p>`;
    return;
  }
  
  messagesDiv.innerHTML = list.map(m=>{
    const isOwnMessage = currentUser && m.author === currentUser.username;
    const isAdminMessage = m.author === ADMIN_USERNAME;
    const messageClass = isOwnMessage ? 'msg own-message' : 'msg';
    
    let authorBadge = '';
    if(isAdminMessage){
      authorBadge = '<span class="badge" style="background:#ef4444;color:#fff;margin-left:.5rem;font-size:.7rem">üëë ADMIN</span>';
    }
    if(isOwnMessage){
      authorBadge += '<span class="badge" style="background:#667eea;color:#fff;margin-left:.5rem;font-size:.7rem">Vous</span>';
    }
    
    return `
      <div class="${messageClass}">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.3rem">
          <strong style="color:${isOwnMessage ? '#667eea' : '#333'}">${escapeHtml(m.author)}</strong>${authorBadge}
          <small>${new Date(m.ts).toLocaleString('fr-FR', {
            day:'2-digit',
            month:'2-digit',
            hour:'2-digit',
            minute:'2-digit'
          })}</small>
        </div>
        <div style="margin-top:.3rem;line-height:1.5">${escapeHtml(m.text)}</div>
      </div>
    `;
  }).join('');
  
  // Scroll automatique vers le bas
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

msgForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  if(!currentUser){ return guardedNav('community'); }
  
  const text = document.getElementById('msg-input').value.trim();
  if(!text) return;
  
  // Recharger les messages avant d'ajouter
  messages = JSON.parse(localStorage.getItem('ola_messages')||'{}');
  
  // Initialiser le salon si n√©cessaire
  if(!messages[currentSalon]){
    messages[currentSalon] = [];
  }
  
  // Ajouter le nouveau message
  messages[currentSalon].push({
    author: currentUser.username,
    text: text,
    ts: Date.now()
  });
  
  // Sauvegarder
  saveMessages();
  
  // Reset et afficher
  e.target.reset();
  renderMessages();
  renderSalons(); // Mettre √† jour le compteur
});

/** =========================
 *  Utilitaires
 *  ========================= */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#039;'
  }[m]));
}

/** =========================
 *  Init
 *  ========================= */
document.addEventListener('DOMContentLoaded', ()=>{
  loadState();
  renderSalons();
  displayServices();

  // Cr√©er un compte admin si n'existe pas
  if(!users.some(u => u.username === ADMIN_USERNAME)){
    users.push({
      id: Date.now(),
      username: ADMIN_USERNAME,
      email: 'admin@olajobs.com',
      password: 'admin2025',
      city: 'Cotonou'
    });
    saveUsers();
    console.log('‚úÖ Compte admin cr√©√©: Allah / admin2025');
  }

  // Bouchon d'exemples si base vide
  if(services.length===0){
    const now = new Date();
    const future1 = new Date(now.getTime()+24*3600*1000);
    const future2 = new Date(now.getTime()+48*3600*1000);
    const future3 = new Date(now.getTime()+72*3600*1000);
    const future4 = new Date(now.getTime()+96*3600*1000);
    const future5 = new Date(now.getTime()+120*3600*1000);
    
    services = [
      {
        id:1,type:'offre',
        title:'Cours de fran√ßais & math√©matiques',
        description:'Prof exp√©riment√© pour primaire & coll√®ge. M√©thode p√©dagogique adapt√©e √† chaque √©l√®ve.',
        category:'cours',location:'Cotonou, Fidjross√®',phone:'+229 90 00 00 00',
        budget:5000,author:'Marie K.',
        datePublished:new Date().toISOString(),
        deadlineISO: future1.toISOString()
      },
      {
        id:2,type:'offre',
        title:'Aide pour d√©m√©nagement',
        description:'Besoin de 2 personnes ce week‚Äëend. Camion disponible. Service rapide et soign√©.',
        category:'transport',location:'Porto‚ÄëNovo',phone:'+229 91 11 11 11',
        budget:15000,author:'Jean B.',
        datePublished:new Date().toISOString(),
        deadlineISO: future2.toISOString()
      },
      {
        id:3,type:'offre',
        title:'R√©paration de climatiseurs',
        description:'Technicien qualifi√©. Diagnostic gratuit. Intervention rapide sous 24h. Garantie 3 mois.',
        category:'bricolage',location:'Cotonou, Akpakpa',phone:'+229 92 22 22 22',
        budget:10000,author:'Koffi A.',
        datePublished:new Date().toISOString(),
        deadlineISO: future3.toISOString()
      },
      {
        id:4,type:'offre',
        title:'Coiffeuse √† domicile',
        description:'Tresses, tissages, soins capillaires. Je me d√©place avec mon mat√©riel professionnel.',
        category:'autre',location:'Cotonou, Cadj√®houn',phone:'+229 93 33 33 33',
        budget:8000,author:'Fatou D.',
        datePublished:new Date().toISOString(),
        deadlineISO: future4.toISOString()
      },
      {
        id:5,type:'offre',
        title:'D√©veloppeur web freelance',
        description:'Cr√©ation de sites web, applications, e-commerce. WordPress, React. Portfolio disponible.',
        category:'informatique',location:'Cotonou, Cococodji',phone:'+229 94 44 44 44',
        budget:50000,author:'Arnaud T.',
        datePublished:new Date().toISOString(),
        deadlineISO: future5.toISOString()
      }
    ];
    saveServices();
  }
  
  // Ajouter quelques messages d'exemple dans les salons si vides
  if(Object.keys(messages).length === 0){
    messages = {
      'entrepreneuriat': [
        {
          author: 'Admin',
          text: 'Bienvenue dans le salon Entrepreneuriat ! Partagez vos projets et id√©es. üöÄ',
          ts: Date.now() - 3600000
        }
      ],
      'numerique': [
        {
          author: 'Admin',
          text: 'Salon d√©di√© aux discussions tech, d√©veloppement web, apps mobiles... üíª',
          ts: Date.now() - 7200000
        }
      ]
    };
    saveMessages();
  }
  
  displayServices();
});

// Nettoyer l'intervalle quand on quitte la page
window.addEventListener('beforeunload', ()=>{
  if(messageRefreshInterval){
    clearInterval(messageRefreshInterval);
  }
});
</script>
</body>
</html>
